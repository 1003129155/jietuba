# æ™ºèƒ½é€‰åŒºåŠŸèƒ½é›†æˆè¯´æ˜

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. åˆ›å»ºæ ¸å¿ƒæ¨¡å— `capture/window_finder.py`

æ™ºèƒ½çª—å£é€‰æ‹©å™¨ï¼ŒåŸºäº Windows API çš„çª—å£æ£€æµ‹åŠŸèƒ½ã€‚

**ä¸»è¦ç±»ï¼š**
- `WindowFinder`: çª—å£æŸ¥æ‰¾å™¨
  - `find_windows()`: æšä¸¾æ‰€æœ‰å¯è§çª—å£
  - `find_window_at_point(x, y)`: æ ¹æ®é¼ æ ‡ä½ç½®æŸ¥æ‰¾çª—å£
  - `set_screen_offset(x, y)`: è®¾ç½®å¤šå±å¹•åæ ‡åç§»

**çª—å£è¿‡æ»¤è§„åˆ™ï¼š**
- âœ… å¿…é¡»å¯è§
- âœ… å¿…é¡»æœ‰æ ‡é¢˜æ 
- âœ… ä¸èƒ½æ˜¯å·¥å…·çª—å£
- âœ… ä¸èƒ½æ˜¯é€æ˜çª—å£
- âœ… å¿…é¡»æœ‰åˆç†å°ºå¯¸ï¼ˆâ‰¥30x30ï¼‰
- âœ… æ’é™¤ç³»ç»Ÿçª—å£ï¼ˆWorkerW, Progmanç­‰ï¼‰

**ä¾èµ–æ£€æŸ¥ï¼š**
- æä¾› `is_smart_selection_available()` å‡½æ•°æ£€æŸ¥æ˜¯å¦å®‰è£… `pywin32`

---

### 2. ä¿®æ”¹ `canvas/view.py` - è§†å›¾å±‚é›†æˆ

**æ–°å¢åŠŸèƒ½ï¼š**
- `enable_smart_selection(enabled)`: å¯ç”¨/ç¦ç”¨æ™ºèƒ½é€‰åŒº
- `_get_smart_selection_rect(scene_pos)`: è·å–é¼ æ ‡ä½ç½®çš„çª—å£çŸ©å½¢

**é¼ æ ‡ç§»åŠ¨äº‹ä»¶å¢å¼ºï¼š**
```python
if self.is_selecting:
    if self.smart_selection_enabled:
        # æ™ºèƒ½æ¨¡å¼ï¼šè‡ªåŠ¨è¯†åˆ«çª—å£è¾¹ç•Œ
        smart_rect = self._get_smart_selection_rect(scene_pos)
        self.canvas_scene.selection_model.set_rect(smart_rect)
    else:
        # æ™®é€šæ¨¡å¼ï¼šçŸ©å½¢æ‹–æ‹½
        rect = QRectF(self.start_pos, scene_pos).normalized()
        self.canvas_scene.selection_model.set_rect(rect)
```

---

### 3. ä¿®æ”¹ `ui/screenshot_window.py` - æˆªå›¾çª—å£é›†æˆ

**å¯åŠ¨æ—¶è¯»å–é…ç½®ï¼š**
```python
# å¯ç”¨æ™ºèƒ½é€‰åŒºï¼ˆä»é…ç½®è¯»å–ï¼‰
smart_selection_enabled = self.config_manager.get_smart_selection()
self.view.enable_smart_selection(smart_selection_enabled)
```

---

### 4. ä¿®æ”¹ `capture/__init__.py` - å¯¼å‡ºæ¥å£

```python
from .window_finder import WindowFinder, is_smart_selection_available

__all__ = ['CaptureService', 'WindowFinder', 'is_smart_selection_available']
```

---

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### ä½¿ç”¨æ–¹å¼

1. **å¯ç”¨æ™ºèƒ½é€‰åŒºï¼š**
   - æ‰“å¼€è®¾ç½®çª—å£ â†’ "æ™ºèƒ½é€‰æ‹©" é¡µé¢
   - å¼€å¯"æ™ºèƒ½é€‰åŒºï¼ˆçª—å£/æ§ä»¶è¯†åˆ«ï¼‰"å¼€å…³

2. **æˆªå›¾æ—¶ï¼š**
   - æŒ‰ä¸‹æˆªå›¾å¿«æ·é”®ï¼ˆé»˜è®¤ F1ï¼‰
   - ç§»åŠ¨é¼ æ ‡ï¼Œä¼šè‡ªåŠ¨è¯†åˆ«çª—å£è¾¹ç•Œ
   - é¼ æ ‡ç§»åˆ°å“ªä¸ªçª—å£ï¼Œé€‰åŒºå°±ä¼šè‡ªåŠ¨æ¡†é€‰é‚£ä¸ªçª—å£
   - ç‚¹å‡»é¼ æ ‡ç¡®è®¤é€‰åŒº

### å·¥ä½œåŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ScreenshotWindow å¯åŠ¨                â”‚
â”‚  â†“                                   â”‚
â”‚  è¯»å–é…ç½® get_smart_selection()       â”‚
â”‚  â†“                                   â”‚
â”‚  CanvasView.enable_smart_selection() â”‚
â”‚  â†“                                   â”‚
â”‚  WindowFinder æšä¸¾æ‰€æœ‰çª—å£            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·ç§»åŠ¨é¼ æ ‡æ—¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  mouseMoveEvent                     â”‚
â”‚  â†“                                   â”‚
â”‚  _get_smart_selection_rect()        â”‚
â”‚  â†“                                   â”‚
â”‚  WindowFinder.find_window_at_point()â”‚
â”‚  â†“                                   â”‚
â”‚  æ›´æ–°é€‰åŒºçŸ©å½¢                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Z-order æ’åºç­–ç•¥

å½“å¤šä¸ªçª—å£é‡å æ—¶ï¼š
1. ä¼˜å…ˆé€‰æ‹© Z-order æœ€å°çš„ï¼ˆæœ€é¡¶å±‚çª—å£ï¼‰
2. å…¶æ¬¡é€‰æ‹©é¢ç§¯æœ€å°çš„ï¼ˆæœ€ç²¾ç¡®çš„çª—å£ï¼‰

è¿™æ ·å¯ä»¥é¿å…é€‰ä¸­åº•å±‚çš„å¤§çª—å£ï¼Œè€Œæ˜¯é€‰ä¸­é¼ æ ‡å®é™…æ‚¬åœçš„å°çª—å£ã€‚

---

## ğŸ“‹ ä¾èµ–è¦æ±‚

### å¿…éœ€ä¾èµ–
- `pywin32`: Windows API è®¿é—®
  ```bash
  pip install pywin32
  ```

### å…¼å®¹æ€§
- âœ… Windows 10/11
- âŒ Linuxï¼ˆä¸æ”¯æŒï¼Œå› ä¸ºä¾èµ– win32guiï¼‰
- âŒ macOSï¼ˆä¸æ”¯æŒï¼Œå› ä¸ºä¾èµ– win32guiï¼‰

---

## ğŸ”§ é…ç½®é¡¹

### `tool_settings.py`
```python
APP_DEFAULT_SETTINGS = {
    "smart_selection": False,  # æ™ºèƒ½é€‰åŒºï¼ˆé»˜è®¤å…³é—­ï¼‰
}
```

### è®¾ç½®ç•Œé¢
- ä½ç½®ï¼šè®¾ç½®çª—å£ â†’ "æ™ºèƒ½é€‰æ‹©" é¡µé¢
- æ§ä»¶ï¼šToggleSwitchï¼ˆå¼€å…³ï¼‰
- ä¿å­˜ï¼šé…ç½®è‡ªåŠ¨ä¿å­˜åˆ°æ³¨å†Œè¡¨

---

## ğŸ› è°ƒè¯•

### å¯ç”¨è°ƒè¯•è¾“å‡º
```python
finder = WindowFinder()
finder.debug = True  # å¯ç”¨è°ƒè¯•è¾“å‡º
finder.find_windows()
```

### è°ƒè¯•ä¿¡æ¯ç¤ºä¾‹
```
ğŸ” [æ™ºèƒ½é€‰åŒº] æ‰¾åˆ° 25 ä¸ªæœ‰æ•ˆçª—å£
ğŸ“‹ [æ™ºèƒ½é€‰åŒº] æ£€æµ‹åˆ°çš„çª—å£åˆ—è¡¨ï¼ˆå‰5ä¸ªï¼‰:
  1. æ ‡é¢˜: Visual Studio Code, å¤§å°: 1920x1080, ä½ç½®: (0, 0)
  2. æ ‡é¢˜: Google Chrome, å¤§å°: 1280x720, ä½ç½®: (320, 180)
  ...
ğŸ¯ [æ™ºèƒ½é€‰åŒº] é¼ æ ‡(640, 360)å¤„æ‰¾åˆ°çª—å£: 'Google Chrome', å¤§å°: 1280x720, Z-order: 1
```

---

## ğŸ“š ä½¿ç”¨ç¤ºä¾‹

### æ‰‹åŠ¨ä½¿ç”¨ WindowFinder
```python
from capture.window_finder import WindowFinder, is_smart_selection_available

# æ£€æŸ¥åŠŸèƒ½æ˜¯å¦å¯ç”¨
if not is_smart_selection_available():
    print("æ™ºèƒ½é€‰åŒºåŠŸèƒ½ä¸å¯ç”¨ï¼ˆç¼ºå°‘ pywin32ï¼‰")
    exit(1)

# åˆ›å»ºæŸ¥æ‰¾å™¨
finder = WindowFinder(screen_offset_x=0, screen_offset_y=0)

# æšä¸¾çª—å£
finder.find_windows()
print(f"æ‰¾åˆ° {len(finder.windows)} ä¸ªçª—å£")

# æŸ¥æ‰¾é¼ æ ‡ä½ç½®çš„çª—å£
rect = finder.find_window_at_point(640, 360)
print(f"çª—å£çŸ©å½¢: {rect}")  # [x1, y1, x2, y2]
```

### åœ¨è§†å›¾ä¸­ä½¿ç”¨
```python
# åœ¨ CanvasView ä¸­
self.enable_smart_selection(True)  # å¯ç”¨æ™ºèƒ½é€‰åŒº

# é¼ æ ‡ç§»åŠ¨æ—¶è‡ªåŠ¨è¯†åˆ«çª—å£
smart_rect = self._get_smart_selection_rect(scene_pos)
```

---

## âœ… æµ‹è¯•æ¸…å•

- [ ] æ£€æŸ¥æ˜¯å¦æ­£ç¡®è¯†åˆ«åº”ç”¨çª—å£ï¼ˆVS Code, Chrome, è®°äº‹æœ¬ç­‰ï¼‰
- [ ] æ£€æŸ¥æ˜¯å¦è¿‡æ»¤æ‰å·¥å…·çª—å£ï¼ˆä»»åŠ¡æ ã€ç³»ç»Ÿæ‰˜ç›˜ç­‰ï¼‰
- [ ] æ£€æŸ¥å¤šå±å¹•ç¯å¢ƒä¸‹çš„åæ ‡è½¬æ¢
- [ ] æ£€æŸ¥çª—å£é‡å æ—¶çš„ Z-order æ’åº
- [ ] æ£€æŸ¥é…ç½®å¼€å…³æ˜¯å¦æ­£å¸¸å·¥ä½œ
- [ ] æ£€æŸ¥ç¼ºå°‘ pywin32 æ—¶çš„é™çº§å¤„ç†

---

## ğŸš€ æœªæ¥æ”¹è¿›

1. **Linux/macOS æ”¯æŒ**
   - ä½¿ç”¨ Xlibï¼ˆLinuxï¼‰æˆ– Quartzï¼ˆmacOSï¼‰å®ç°è·¨å¹³å°æ”¯æŒ

2. **æ§ä»¶çº§è¯†åˆ«**
   - å½“å‰åªè¯†åˆ«é¡¶å±‚çª—å£
   - å¯ä»¥æ‰©å±•åˆ°è¯†åˆ«çª—å£å†…çš„å­æ§ä»¶ï¼ˆæŒ‰é’®ã€è¾“å…¥æ¡†ç­‰ï¼‰

3. **æ€§èƒ½ä¼˜åŒ–**
   - ç¼“å­˜çª—å£åˆ—è¡¨ï¼Œé¿å…æ¯æ¬¡é¼ æ ‡ç§»åŠ¨éƒ½é‡æ–°æšä¸¾
   - å®šæœŸåˆ·æ–°ï¼ˆä¾‹å¦‚æ¯ 500msï¼‰

4. **è§†è§‰åé¦ˆå¢å¼º**
   - æ˜¾ç¤ºå½“å‰è¯†åˆ«çš„çª—å£æ ‡é¢˜
   - é«˜äº®æ˜¾ç¤ºçª—å£è¾¹ç•Œ

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **éšç§é—®é¢˜**
   - æ™ºèƒ½é€‰åŒºéœ€è¦æšä¸¾æ‰€æœ‰çª—å£ï¼Œå¯èƒ½è·å–æ•æ„Ÿçª—å£æ ‡é¢˜
   - å»ºè®®æ·»åŠ éšç§è¯´æ˜

2. **æƒé™è¦æ±‚**
   - æŸäº›å—ä¿æŠ¤çš„ç³»ç»Ÿçª—å£å¯èƒ½æ— æ³•è¯†åˆ«
   - éœ€è¦ç®¡ç†å‘˜æƒé™æ‰èƒ½æšä¸¾æŸäº›çª—å£

3. **æ€§èƒ½å½±å“**
   - æšä¸¾çª—å£æœ‰ä¸€å®šæ€§èƒ½å¼€é”€
   - å»ºè®®ä»…åœ¨å¯ç”¨æ™ºèƒ½é€‰åŒºæ—¶æ‰æšä¸¾çª—å£

---

## ğŸ“– å‚è€ƒèµ„æ–™

- [pywin32 æ–‡æ¡£](https://pypi.org/project/pywin32/)
- [Windows API - EnumWindows](https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-enumwindows)
- [Window Styles](https://docs.microsoft.com/en-us/windows/win32/winmsg/window-styles)
